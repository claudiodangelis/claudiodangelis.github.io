<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Dart, Web UI + js libraries, Google+ API &middot; Claudio d'Angelis Blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Claudio d'Angelis Blog
        </a>
      </h1>
      <p class="lead">IT Consultant.<br/> Ad Tech, Unix, Progressive Rock.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

            
      <a class="sidebar-nav-item" href="/about.html">About</a>
          
      <a class="sidebar-nav-item" href="/archive.html">Archive</a>
                
    </nav>
    <div class="social-links">
      <p>
        <small>email</small>
        <a href='&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#99;&#108;&#97;&#117;&#100;&#105;&#111;&#100;&#97;&#110;&#103;&#101;&#108;&#105;&#115;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;'><em>(click)</em></a><br/>
        <small>github</small>
        <a href="https://github.com/claudiodangelis"> claudiodangelis</a><br/>
        <small>twitter</small>
        <a href="https://twitter.com/daw985">daw985</a><br/>
        <small>linkedin</small>
        <a href="https://linkedin.com/in/claudiodangelis">/in/claudiodangelis</a><br/>
        <small>archlinux</small> <a href="https://aur.archlinux.org/packages/?SeB=m&K=claudiodangelis"> AUR packages</a>
        <br/><a href="/feed.xml">RSS feed</a>

      </p>
    </div>
    <small>
      &copy; 2018. All rights reserved.<br/>
      P.IVA/VAT ID 02856420597
    </small>
  </div>
</div>


    <div class="content container">
      <p>Today’s blog post is about a sample application that uses Web UI and js libraries and shows some information about you on Google+. To retrieve these informations, application uses the <a href="http://code.google.com/p/google-api-javascript-client/">Google APIs Client Library for JavaScript</a>.</p>

<p>Funny story:  I chose to use Google API <strong>javascript</strong> client (handled with dart js-interop library) instead of <strong>dart</strong> client since the latter was outdated and while I was editing the code an interesting project appeared on GitHub: <a href="https://github.com/Scarygami/dart-google-oauth2-library">dart-google-oauth2-library</a> by <a href="https://plus.google.com/112336147904981294875/posts">+Gerwin Sturm</a>. <em>dart-google-oauth2-library</em>  simplifies the whole authentication process in a significant way, so please consider the following just as an example of how js-interop works.</p>

<!--more-->
<h2 id="the-application">The application</h2>

<p>The applicaton is very simple: once you have authenticated and the application is allowed to access your Google+ profile data, some information will be displayed: name, profile picture, tagline, “about me” and links.</p>

<div class="row-fluid">
  <img src="/assets/img/posts/dart-mdv-googleplus-1.png" />
  <img src="/assets/img/posts/dart-mdv-googleplus-2.png" />

</div>
<p><br /></p>

<p>We need the <a href="https://github.com/dart-lang/web-ui">web_ui</a> library because application uses <strong>Model-driven Views (MDV)</strong> to bind data and HTML interface, and <a href="https://github.com/dart-lang/js-interop">js-interop</a> library to handle the Google APIs client, so the <strong>pubspec.yaml</strong> file will be:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">name</span><span class="pi">:</span>  <span class="s">dart_mdv_googleplus</span>
<span class="na">description</span><span class="pi">:</span>  <span class="s">A sample application</span>
<span class="na">dependencies</span><span class="pi">:</span>
  <span class="na">js</span><span class="pi">:</span> <span class="s">any</span>
  <span class="na">web_ui</span><span class="pi">:</span> <span class="s">any</span></code></pre></figure>

<p>We also need a compiler to build our MDV template, let’s call it <strong>build.dart</strong>:</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="kn">import</span> <span class="s">'package:web_ui/component_build.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'dart:io'</span><span class="o">;</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">build</span><span class="o">(</span><span class="k">new</span> <span class="n">Options</span><span class="o">().</span><span class="na">arguments</span><span class="o">,</span> <span class="o">[</span><span class="s">'web/google_plus.html'</span><span class="o">]);</span>
<span class="o">}</span></code></pre></figure>

<h2 id="the-dart-code">The DART code</h2>

<h3 id="code-highlights">Code highlights</h3>

<p>First of all, we have to import some libraries:</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="kn">import</span> <span class="s">'dart:json'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:js/js.dart'</span> <span class="k">as</span> <span class="n">js</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:web_ui/watcher.dart'</span> <span class="k">as</span> <span class="n">watchers</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:web_ui/safe_html.dart'</span><span class="o">;</span></code></pre></figure>

<p><strong>watchers</strong> library contains declaration of <code class="highlighter-rouge">dispatch()</code> method, we need it to update HTML interface values with the current Dart values.
We’ll soon see why we are importing <strong>safe_html</strong>.</p>

<p>Let’s go on:</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="kd">final</span> <span class="kt">String</span> <span class="n">CLIENT_ID</span> <span class="o">=</span> <span class="s">'688X10452XXX.apps.googleusercontent.com'</span><span class="o">;</span>
<span class="kd">final</span> <span class="kt">String</span> <span class="n">SCOPE</span> <span class="o">=</span> <span class="s">'https://www.googleapis.com/auth/plus.me'</span><span class="o">;</span></code></pre></figure>

<p><strong>CLIENT_ID</strong> and <strong>SCOPE</strong> are required to gain application access, here’s more on how <a href="https://developers.google.com/accounts/docs/OAuth2">Using OAuth 2.0 to Access Google APIs</a>.</p>

<p>Now see how Javascript functions are handled by Dart <code class="highlighter-rouge">js</code> library:</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="n">js</span><span class="o">.</span><span class="na">scoped</span><span class="o">((){</span>
<span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">init</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="o">.</span><span class="na">Callback</span><span class="o">.</span><span class="na">once</span><span class="o">((){</span>
  <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">window</span><span class="o">.</span><span class="na">setTimeout</span><span class="o">(</span><span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">auth</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
  <span class="o">});</span>

<span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">auth</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="o">.</span><span class="na">Callback</span><span class="o">.</span><span class="na">many</span><span class="o">((){</span>
  <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">gapi</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">setApiKey</span><span class="o">(</span><span class="s">'AIzaSyDOtMNdtbw17o9bs-kW7G6O3S05p0H8wYM'</span><span class="o">);</span>
  <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">window</span><span class="o">.</span><span class="na">setTimeout</span><span class="o">(</span>
    <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">gapi</span><span class="o">.</span><span class="na">auth</span><span class="o">.</span><span class="na">authorize</span><span class="o">(</span><span class="n">js</span><span class="o">.</span><span class="na">map</span><span class="o">({</span>
    <span class="s">'client_id'</span><span class="o">:</span><span class="n">CLIENT_ID</span><span class="o">,</span>
    <span class="s">'scope'</span><span class="o">:</span><span class="n">SCOPE</span><span class="o">,</span>
    <span class="s">'immediate'</span><span class="o">:</span><span class="n">immediate</span>
    <span class="o">}),</span>
    <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">onAuthResponse</span><span class="o">),</span> <span class="mi">1</span>
  <span class="o">);</span>
<span class="o">});</span>

<span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">onAuthResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="o">.</span><span class="na">Callback</span><span class="o">.</span><span class="na">many</span><span class="o">((</span><span class="n">js</span><span class="o">.</span><span class="na">Proxy</span> <span class="n">token</span><span class="o">){</span>
  <span class="k">if</span><span class="o">(</span><span class="n">token</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
    <span class="n">authBtn</span><span class="o">.</span><span class="na">style</span><span class="o">.</span><span class="na">display</span><span class="o">=</span><span class="s">'none'</span><span class="o">;</span>
    <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">MakeRequest</span><span class="o">();</span>
    <span class="n">immediate</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">else</span><span class="o">{</span>
    <span class="n">authBtn</span><span class="o">.</span><span class="na">style</span><span class="o">.</span><span class="na">display</span><span class="o">=</span><span class="s">'block'</span><span class="o">;</span>
    <span class="n">immediate</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">});</span></code></pre></figure>

<p>You see that:</p>

<ol>
  <li>all the code is wrapped into the <code class="highlighter-rouge">js.scoped()</code> method</li>
  <li>there are two kinds of <code class="highlighter-rouge">Callback</code>, <strong>once</strong> and <strong>many</strong></li>
</ol>

<p>This aims to prevent memory leaks. When you run code inside a local <em>scope</em>, all contents created whithin that scope are released and garbage collected after code exits that scope; likewise, you can use Callback’s <code class="highlighter-rouge">once</code> or <code class="highlighter-rouge">many</code> method according to how many times your callback function has to be executed: if you’re using <code class="highlighter-rouge">once</code>, after the first execution the callback will be disposed. More about <a href="http://www.dartlang.org/articles/js-dart-interop/">Using JavaScript from Dart</a>.</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">RequestCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="o">.</span><span class="na">Callback</span><span class="o">.</span><span class="na">once</span><span class="o">((</span><span class="n">js</span><span class="o">.</span><span class="na">Proxy</span> <span class="n">jsonResp</span><span class="o">,</span> <span class="kd">var</span> <span class="n">rawResp</span><span class="o">){</span>
  <span class="kd">var</span> <span class="n">data</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">rawResp</span><span class="o">);</span>

  <span class="k">for</span><span class="o">(</span> <span class="kd">var</span> <span class="n">url</span> <span class="k">in</span> <span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="s">'result'</span><span class="o">][</span><span class="s">'urls'</span><span class="o">]){</span>
    <span class="n">urls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">url</span><span class="o">[</span><span class="s">'value'</span><span class="o">]);</span>
  <span class="o">}</span>
  <span class="n">displayName</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="s">'result'</span><span class="o">][</span><span class="s">'displayName'</span><span class="o">];</span>
  <span class="n">tagline</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="s">'result'</span><span class="o">][</span><span class="s">'tagline'</span><span class="o">];</span>
  <span class="n">pic</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="s">'result'</span><span class="o">][</span><span class="s">'image'</span><span class="o">][</span><span class="s">'url'</span><span class="o">];</span>
  <span class="n">aboutMe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SafeHtml</span><span class="o">.</span><span class="na">unsafe</span><span class="o">(</span><span class="s">'&lt;div&gt;''</span><span class="si">${data[0]['result']['aboutMe']}</span><span class="s">&lt;/div&gt;'</span><span class="o">);</span>

  <span class="n">watchers</span><span class="o">.</span><span class="na">dispatch</span><span class="o">();</span>

<span class="o">});</span></code></pre></figure>

<p><code class="highlighter-rouge">RequestCallback</code> is the function that is invoked when application receives <code class="highlighter-rouge">MakeRequest</code> response. Recieved data, <code class="highlighter-rouge">rawResp</code>, are parsed and converted to JSON, this will ease the process of assigning values to variables. There’s nothing special here but this line:</p>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="n">aboutMe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SafeHtml</span><span class="o">.</span><span class="na">unsafe</span><span class="o">(</span><span class="s">'&lt;div&gt;''</span><span class="si">${data[0]['result']['aboutMe']}</span><span class="s">&lt;/div&gt;'</span><span class="o">);</span></code></pre></figure>

<p>Returned value of ‘aboutMe’ is actually a piece of HTML code; allowing an unknown piece of HTML that comes from the outside to be included in your app would represent a <strong>security flaw</strong>, so HTML is passed as regular text by default, e.g. “&lt;span&gt;hello &lt;a href=’/world’&gt;world&lt;a&gt;&lt;/span&gt;”.
If we’re 100% sure about safety of HTML code, this behaviour can be overridden by the <code class="highlighter-rouge">unsafe</code> method of <code class="highlighter-rouge">SafeHtml</code> class; since only one top-level element is allowed to be passed as argument of <code class="highlighter-rouge">unsafe()</code> we can just wrap the code inside a <code class="highlighter-rouge">div</code> element.</p>

<h3 id="full-code">Full code</h3>

<figure class="highlight"><pre><code class="language-dart" data-lang="dart"><span class="kn">import</span> <span class="s">'dart:html'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'dart:json'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:js/js.dart'</span> <span class="k">as</span> <span class="n">js</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:web_ui/watcher.dart'</span> <span class="k">as</span> <span class="n">watchers</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:web_ui/safe_html.dart'</span><span class="o">;</span>

<span class="kd">final</span> <span class="kt">String</span> <span class="n">CLIENT_ID</span> <span class="o">=</span> <span class="s">'688110452481.apps.googleusercontent.com'</span><span class="o">;</span>
<span class="kd">final</span> <span class="kt">String</span> <span class="n">SCOPE</span> <span class="o">=</span> <span class="s">'https://www.googleapis.com/auth/plus.me'</span><span class="o">;</span>

<span class="n">ButtonElement</span> <span class="n">authBtn</span> <span class="o">=</span> <span class="n">query</span><span class="o">(</span><span class="s">'#authorize'</span><span class="o">);</span>

<span class="kt">bool</span> <span class="n">immediate</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

<span class="kt">String</span> <span class="n">displayName</span> <span class="o">=</span> <span class="s">'Me'</span><span class="o">;</span>
<span class="kt">String</span> <span class="n">tagline</span><span class="o">;</span>
<span class="n">SafeHtml</span> <span class="n">aboutMe</span><span class="o">;</span>
<span class="kt">String</span> <span class="n">pic</span><span class="o">;</span>

<span class="n">List</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span> <span class="n">urls</span> <span class="o">=</span> <span class="o">[];</span>

<span class="n">main</span><span class="o">(){</span>

  <span class="n">js</span><span class="o">.</span><span class="na">scoped</span><span class="o">((){</span>
    <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">init</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="o">.</span><span class="na">Callback</span><span class="o">.</span><span class="na">once</span><span class="o">((){</span>
      <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">window</span><span class="o">.</span><span class="na">setTimeout</span><span class="o">(</span><span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">auth</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
      <span class="o">});</span>

    <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">auth</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="o">.</span><span class="na">Callback</span><span class="o">.</span><span class="na">many</span><span class="o">((){</span>
      <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">gapi</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">setApiKey</span><span class="o">(</span><span class="s">'AIzaSyDOtMNdtbw17o9bs-kW7G6O3S05p0H8wYM'</span><span class="o">);</span>
      <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">window</span><span class="o">.</span><span class="na">setTimeout</span><span class="o">(</span>
        <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">gapi</span><span class="o">.</span><span class="na">auth</span><span class="o">.</span><span class="na">authorize</span><span class="o">(</span><span class="n">js</span><span class="o">.</span><span class="na">map</span><span class="o">({</span>
        <span class="s">'client_id'</span><span class="o">:</span><span class="n">CLIENT_ID</span><span class="o">,</span>
        <span class="s">'scope'</span><span class="o">:</span><span class="n">SCOPE</span><span class="o">,</span>
        <span class="s">'immediate'</span><span class="o">:</span><span class="n">immediate</span>
        <span class="o">}),</span>
        <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">onAuthResponse</span><span class="o">),</span> <span class="mi">1</span>
      <span class="o">);</span>
    <span class="o">});</span>


    <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">onAuthResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="o">.</span><span class="na">Callback</span><span class="o">.</span><span class="na">many</span><span class="o">((</span><span class="n">js</span><span class="o">.</span><span class="na">Proxy</span> <span class="n">token</span><span class="o">){</span>
      <span class="k">if</span><span class="o">(</span><span class="n">token</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
        <span class="n">authBtn</span><span class="o">.</span><span class="na">style</span><span class="o">.</span><span class="na">display</span><span class="o">=</span><span class="s">'none'</span><span class="o">;</span>
        <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">MakeRequest</span><span class="o">();</span>
        <span class="n">immediate</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">else</span><span class="o">{</span>
        <span class="n">authBtn</span><span class="o">.</span><span class="na">style</span><span class="o">.</span><span class="na">display</span><span class="o">=</span><span class="s">'block'</span><span class="o">;</span>
        <span class="n">immediate</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">});</span>

    <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">MakeRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="o">.</span><span class="na">Callback</span><span class="o">.</span><span class="na">once</span><span class="o">((){</span>
      <span class="n">js</span><span class="o">.</span><span class="na">scoped</span><span class="o">((){</span>
        <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">gapi</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="s">'plus'</span><span class="o">,</span> <span class="s">'v1'</span><span class="o">,</span> <span class="k">new</span> <span class="n">js</span><span class="o">.</span><span class="na">Callback</span><span class="o">.</span><span class="na">once</span><span class="o">((){</span>
          <span class="kd">var</span> <span class="n">request</span> <span class="o">=</span> <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">gapi</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">plus</span><span class="o">.</span><span class="na">people</span><span class="o">.</span><span class="na">get</span><span class="o">(</span>
              <span class="n">js</span><span class="o">.</span><span class="na">map</span><span class="o">({</span>
                <span class="s">'userId'</span><span class="o">:</span><span class="s">'me'</span><span class="o">,</span>
                <span class="s">'fields'</span><span class="o">:</span><span class="s">'aboutMe,circledByCount,displayName,image,tagline,urls/value'</span>
              <span class="o">}));</span>
          <span class="n">request</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">RequestCallback</span><span class="o">);</span>
        <span class="o">}));</span>
      <span class="o">});</span>
    <span class="o">});</span>
    <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">RequestCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="o">.</span><span class="na">Callback</span><span class="o">.</span><span class="na">once</span><span class="o">((</span><span class="n">js</span><span class="o">.</span><span class="na">Proxy</span> <span class="n">jsonResp</span><span class="o">,</span> <span class="kd">var</span> <span class="n">rawResp</span><span class="o">){</span>
      <span class="kd">var</span> <span class="n">data</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">rawResp</span><span class="o">);</span>

      <span class="k">for</span><span class="o">(</span> <span class="kd">var</span> <span class="n">url</span> <span class="k">in</span> <span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="s">'result'</span><span class="o">][</span><span class="s">'urls'</span><span class="o">]){</span>
        <span class="n">urls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">url</span><span class="o">[</span><span class="s">'value'</span><span class="o">]);</span>
      <span class="o">}</span>
      <span class="n">displayName</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="s">'result'</span><span class="o">][</span><span class="s">'displayName'</span><span class="o">];</span>
      <span class="n">tagline</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="s">'result'</span><span class="o">][</span><span class="s">'tagline'</span><span class="o">];</span>
      <span class="n">pic</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="s">'result'</span><span class="o">][</span><span class="s">'image'</span><span class="o">][</span><span class="s">'url'</span><span class="o">];</span>
      <span class="n">aboutMe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SafeHtml</span><span class="o">.</span><span class="na">unsafe</span><span class="o">(</span><span class="s">'&lt;div&gt;''</span><span class="si">${data[0]['result']['aboutMe']}</span><span class="s">&lt;/div&gt;'</span><span class="o">);</span>

      <span class="n">watchers</span><span class="o">.</span><span class="na">dispatch</span><span class="o">();</span>

    <span class="o">});</span>
  <span class="o">});</span>

  <span class="n">authBtn</span><span class="o">.</span><span class="na">on</span><span class="o">.</span><span class="na">click</span><span class="o">.</span><span class="na">add</span><span class="o">((</span><span class="n">Event</span> <span class="n">e</span><span class="o">){</span>
      <span class="n">js</span><span class="o">.</span><span class="na">scoped</span><span class="o">((){</span>
        <span class="n">js</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">auth</span><span class="o">();</span>
        <span class="o">});</span>
      <span class="o">});</span>

  <span class="n">ScriptElement</span> <span class="n">script</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScriptElement</span><span class="o">();</span>
  <span class="n">script</span><span class="o">.</span><span class="na">src</span> <span class="o">=</span> <span class="s">"http://apis.google.com/js/client.js?onload=init"</span><span class="o">;</span>
  <span class="n">script</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="s">"text/javascript"</span><span class="o">;</span>
  <span class="n">document</span><span class="o">.</span><span class="na">body</span><span class="o">.</span><span class="na">children</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">script</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h2 id="the-html-interface">The HTML interface</h2>

<p>The app interface is really simple:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;p&gt;&lt;b&gt;</span>{{ displayName }} on Google+<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>

<span class="nt">&lt;template</span> <span class="na">instantiate=</span><span class="s">"if tagline != null"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;p&gt;&lt;em&gt;</span>{{ tagline }}<span class="nt">&lt;/em&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"authorize"</span><span class="nt">&gt;</span>Authorize<span class="nt">&lt;/button&gt;</span>

<span class="nt">&lt;template</span> <span class="na">instantiate=</span><span class="s">"if pic != null"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">id=</span><span class="s">"pic"</span> <span class="na">src=</span><span class="s">"{{ pic }}"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/template&gt;</span>

  <span class="nt">&lt;template</span> <span class="na">instantiate=</span><span class="s">"if aboutMe != null"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"about"</span><span class="nt">&gt;</span>{{ aboutMe }}<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/template&gt;</span>


<span class="nt">&lt;template</span> <span class="na">instantiate=</span><span class="s">"if urls.length != 0 "</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;template</span> <span class="na">iterate=</span><span class="s">"url in urls"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url }}"</span><span class="nt">&gt;</span>{{ url }}<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;/template&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/template&gt;</span></code></pre></figure>

<p>Elements wrapped in curly brackets, e.g. <strong></strong>, are MDV placeholders for data.</p>

<p>If a user had not set, on his Google+ profile, one of the fields, API returns <em>null</em> data; to avoid showing “null”, we can decide to instatiate the element only if value of field is not equal to “null”:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;template</span> <span class="na">instantiate=</span><span class="s">"if aboutMe != null"</span><span class="nt">&gt;</span></code></pre></figure>

<p>Last interesting thing to show is how web_ui handles Dart lists:</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;template</span> <span class="na">iterate=</span><span class="s">"url in urls"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"{{ url }}"</span><span class="nt">&gt;</span>{{ url }}<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
<span class="nt">&lt;/template&gt;</span></code></pre></figure>

<p>You can intuitively read it as: “<em>for each <strong>url</strong> in <strong>urls</strong> do something with <strong>url</strong></em>”.</p>

<h2 id="demo-and-source-code">Demo and source code</h2>

<p>You can play with it  following this link (javascript version): <a href="/demo/dart-mdv-googleplus/web/out/google_plus.html">dart-mdv-googleplus</a></p>

<p>or get the <a href="https://github.com/claudiodangelis/dart-mdv-googleplus">code at github</a></p>

    </div>

  </body>
</html>
